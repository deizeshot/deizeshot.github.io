<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DARK Chat</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://use.fontawesome.com/releases/v5.15.3/css/all.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">

</head>
<body>
  
  <div class="chat-container">
    <div class="chat-messages-container">
      <ul id="chat-messages">
        <!-- Пример сообщения, отправленного текущим пользователем -->
        <!-- Добавьте здесь другие сообщения с соответствующими классами -->
      </ul>
    </div>
    
    <div class="chat-input-box">
      <div class="chat-input">
        <input type="text" id="chat-input" placeholder="Сообщение..." onkeypress="handleKeyPress(event)">
        
        <div class="send-button">

          <button id="delete-chat-button" onclick="clearChat()">
            <i class="fas fa-trash-alt"></i>
          </button>

        <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
          
        </div>
      </div>     
    </div>
  </div>
  
  <!-- Модальное окно для увеличенного просмотра фото -->
  <div class="modal" id="myModal">
    <span class="close" onclick="closeModal()">&times;</span>
    <img class="modal-content" id="modalImage">
  </div>

  <script>

    // Обработчик клика по иконке корзины
    const deleteChatButton = document.getElementById('delete-chat-button');
    deleteChatButton.addEventListener('click', () => {
      // Отправляем запрос на сервер для удаления чата
      deleteChat();
    });

    function deleteChat() {
      // Отправляем POST-запрос на сервер с указанием команды для удаления чата
      fetch('/clearChat', {
        method: 'POST',
      })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // После успешного удаления чата, перезагружаем страницу
          window.location.reload();
        } else {
          console.error('Что-то пошло не так при удалении чата:', data.error);
        }
      })
      .catch((error) => {
        console.error('Произошла ошибка при отправке запроса на удаление чата:', error);
      });
    }

  </script>

  <script>
  function openModal(imgElement) {
    const modal = document.getElementById('myModal');
    const modalImg = document.getElementById('modalImage');

    modal.style.display = 'block';
    modalImg.src = imgElement.src;
    modalImg.classList.add('fade-in');
  }

  function closeModal() {
    const modal = document.getElementById('myModal');
    const modalImg = document.getElementById('modalImage');

    modalImg.classList.remove('fade-in');
    modal.style.display = 'none';
  }

  // Получаем все фотографии в чате
  const chatImages = document.querySelectorAll('.chat-messages-container li img');

  // Добавляем обработчик клика для каждой фотографии
  chatImages.forEach((image) => {
    image.addEventListener('click', () => openModal(image));
  });
</script>
  
<script>
    // Ваш JavaScript код
function openModal(imgElement) {
  const modal = document.getElementById('myModal');
  const modalImg = document.getElementById('modalImage');

  modal.style.display = 'block';
  modalImg.src = imgElement.src;
  modalImg.classList.add('fade-in');
}

function closeModal() {
  const modal = document.getElementById('myModal');
  const modalImg = document.getElementById('modalImage');

  modalImg.classList.remove('fade-in');
  modal.style.display = 'none';
}
  </script>

<script>

  const ws = new WebSocket('wss://intermediate-easy-ship.glitch.me/narko');

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'chatMessage') {
      displayChatMessage(data.message);
    } else if (data.type === 'chatHistory') {
      data.history.forEach((message) => {
        displayChatMessage(message);
      });
    }
  };

  function loadChatHistory() {
    const currentChat = window.location.pathname.split("/")[1]; // Получаем текущий чат из URL
    const ws = new WebSocket('wss://intermediate-easy-ship.glitch.me/narko');
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'chatMessage') {
        // Отображаем полученное сообщение чата на странице
        displayChatMessage(data.message);
      } else if (data.type === 'chatHistory') {
        // Отображаем историю чата при подключении
        data.history.forEach((message) => {
          displayChatMessage(message);
        });
      }
    };
  }

  loadChatHistory();

  // Функция для отправки сообщения чата
  function sendMessage() {
    const chatInput = document.getElementById("chat-input");
    const message = chatInput.value;
    if (message.trim() !== '') {
      const chatMessage = { type: 'chatMessage', message };
      ws.send(JSON.stringify(chatMessage));
      chatInput.value = '';
    }
  }

  function displayChatMessage(message) {
    const chatMessagesContainer = document.getElementById("chat-messages");
    const listItem = document.createElement("li");

    if (message.type === "chatMessage") {
      const textNode = document.createTextNode(message.message);
      listItem.appendChild(textNode);
    } else if (message.type === "chatImage") {
      const image = document.createElement("img");
      image.src = message.image;
      listItem.appendChild(image);
    }

    chatMessagesContainer.appendChild(listItem);
  }

  // Функция для определения, является ли сообщение изображением
  function isImageMessage(message) {
    try {
      const url = new URL(message);
      return url.protocol === 'data:';
    } catch (error) {
      return false;
    }
  }

  // Обработка нажатия клавиши Enter в поле ввода чата
  function handleKeyPress(event) {
    if (event.key === 'Enter') {
      sendMessage();
    }
  }
  
  // Обработчик выбора изображения
  document.getElementById('image-input').addEventListener('change', (event) => {
    const file = event.target.files[0];
    const reader = new FileReader();

    reader.onload = (e) => {
      const imageBase64 = e.target.result;
      const chatImage = { type: 'chatImage', image: imageBase64 };
      ws.send(JSON.stringify(chatImage));
    };
    reader.readAsDataURL(file);
  });
  
  const imageInput = document.getElementById('image-input');
  imageInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        const imageBase64 = reader.result.split(',')[1];
        sendImage(imageBase64);
      };
      reader.readAsDataURL(file);
    }
  });

  function sendImage(imageBase64) {
    if (imageBase64) {
      const chatImage = { type: 'chatImage', image: imageBase64 };
      ws.send(JSON.stringify(chatImage));
    }
  }
</script>
  
</body>
</html>